# -*- coding: utf-8 -*-
"""Bitcoin and FEDformer.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Jw3FWZ-HHfLoSnnQPUQbCBZleWWTd-07

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫
"""

# Commented out IPython magic to ensure Python compatibility.
!git clone https://github.com/MAZiqing/FEDformer.git
# %cd FEDformer

!pip install einops pandas scikit-image scikit-learn scipy statsmodels sympy matplotlib yfinance pywavelets

!pip install ydata-profiling

!pip install optuna

"""# –ê–Ω–∞–ª—ñ–∑ –¥–∞–Ω–∏—Ö"""

import pandas as pd
import numpy as np


df = pd.read_csv('/content/BTC-USD.csv')
df.rename(columns={'Date': 'date'}, inplace=True)

df.to_csv('/content/BTC-USD.csv', index=False)

print(df.info())
print(df.head())

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from statsmodels.tsa.seasonal import seasonal_decompose
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf

print("–ü–µ—Ä—à—ñ 5 —Ä—è–¥–∫—ñ–≤:")
print(df.head())
print("\n–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–∞—Ç–∞—Å–µ—Ç:")
print(df.info())
print("\n–°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∏–π –æ–ø–∏—Å:")
print(df.describe())

print("\n–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫—ñ–≤ —É –∫–æ–∂–Ω—ñ–π –∫–æ–ª–æ–Ω—Ü—ñ:")
print(df.isnull().sum())

df['date'] = pd.to_datetime(df['date'])

# –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ü—ñ–Ω–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è
plt.figure(figsize=(14,6))
plt.plot(df['date'], df['Close'], label='Close Price')
plt.title("–î–∏–Ω–∞–º—ñ–∫–∞ —Ü—ñ–Ω–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è Bitcoin")
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–¶—ñ–Ω–∞ (USD)')
plt.legend()
plt.show()

# –†–æ–∑–∫–ª–∞–¥ —Ç—Ä–µ–Ω–¥—É —ñ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—ñ
result = seasonal_decompose(df['Close'], model='multiplicative', period=365)
result.plot()
plt.show()

# –ê–≤—Ç–æ–∫–æ—Ä–µ–ª—è—Ü—ñ—è —ñ —á–∞—Å—Ç–∫–æ–≤–∞ –∞–≤—Ç–æ–∫–æ—Ä–µ–ª—è—Ü—ñ—è
plot_acf(df['Close'].dropna(), lags=50)
plot_pacf(df['Close'].dropna(), lags=50)
plt.show()

# –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ–ø—É—Å–∫—ñ–≤
sns.heatmap(df.isnull(), cbar=False)
plt.title('–ü—Ä–æ–ø—É—Å–∫–∏ —É –¥–∞–Ω–∏—Ö')
plt.show()

# –ö–æ—Ä–µ–ª—è—Ü—ñ—è –º—ñ–∂ –æ–∑–Ω–∞–∫–∞–º–∏
corr = df[['Open','High','Low','Close','Volume']].corr()
plt.figure(figsize=(8,6))
sns.heatmap(corr, annot=True, cmap='coolwarm')
plt.title('–ö–æ—Ä–µ–ª—è—Ü—ñ—è –º—ñ–∂ –æ–∑–Ω–∞–∫–∞–º–∏')
plt.show()

# –ê–Ω–∞–ª—ñ–∑ –¥–æ–±–æ–≤–∏—Ö –¥–æ—Ö—ñ–¥–Ω–æ—Å—Ç–µ–π (returns)
df['returns'] = df['Close'].pct_change()
plt.figure(figsize=(14,6))
plt.plot(df['date'], df['returns'])
plt.title("–©–æ–¥–µ–Ω–Ω—ñ –∑–º—ñ–Ω–∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—ñ")
plt.show()

import os
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from statsmodels.tsa.seasonal import seasonal_decompose
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf

os.makedirs('plots', exist_ok=True)
df['date'] = pd.to_datetime(df['date'])

# –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ü—ñ–Ω–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è
plt.figure(figsize=(14,6))
plt.plot(df['date'], df['Close'], label='Close Price')
plt.title("–î–∏–Ω–∞–º—ñ–∫–∞ —Ü—ñ–Ω–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è Bitcoin")
plt.xlabel('–î–∞—Ç–∞')
plt.ylabel('–¶—ñ–Ω–∞ (USD)')
plt.legend()
plt.savefig('plots/close_price.png')
plt.close()

# –†–æ–∑–∫–ª–∞–¥ —Ç—Ä–µ–Ω–¥—É —ñ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—ñ
result = seasonal_decompose(df['Close'], model='multiplicative', period=365)
fig = result.plot()
fig.set_size_inches(14, 10)
fig.savefig('plots/seasonal_decompose.png')
plt.close(fig)

# –ê–≤—Ç–æ–∫–æ—Ä–µ–ª—è—Ü—ñ—è
fig, ax = plt.subplots(2,1, figsize=(14,10))
plot_acf(df['Close'].dropna(), lags=50, ax=ax[0])
plot_pacf(df['Close'].dropna(), lags=50, ax=ax[1])
fig.savefig('plots/acf_pacf.png')


plt.close(fig)

# –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ–ø—É—Å–∫—ñ–≤
plt.figure(figsize=(14,6))
sns.heatmap(df.isnull(), cbar=False)
plt.title('Missing Data Heatmap')
plt.savefig('plots/missing_data.png')
plt.close()

# –ö–æ—Ä–µ–ª—è—Ü—ñ—è
plt.figure(figsize=(8,6))
sns.heatmap(df[['Open','High','Low','Close','Volume']].corr(), annot=True, cmap='coolwarm')
plt.savefig('plots/correlation.png')

plt.close()

# –î–æ–±–æ–≤—ñ –¥–æ—Ö—ñ–¥–Ω–æ—Å—Ç—ñ
df['returns'] = df['Close'].pct_change()
plt.figure(figsize=(14,6))
plt.plot(df['date'], df['returns'])
plt.title("–©–æ–¥–µ–Ω–Ω—ñ –∑–º—ñ–Ω–∏ –¥–æ—Ö—ñ–¥–Ω–æ—Å—Ç—ñ")
plt.savefig('plots/daily_returns.png')
plt.close()

print("–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ø–∞–ø—Ü—ñ 'plots/'")

from ydata_profiling import ProfileReport

profile = ProfileReport(df, title="Crypto Data Profiling Report")
profile.to_file("crypto_data_report.html")

"""# –ó–∞–ø—É—Å–∫ Optuna"""

!python optuna_fedformer.py

"""# –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –∑ –Ω–∞–π–∫—Ä–∞—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""

import json
import subprocess

with open("/content/FEDformer/results/best_params.json", "r") as f:
    best_params = json.load(f)

print("Loaded best params:")
print(best_params)

cmd = f"""
python run_custom.py \
--is_training 1 \
--task_id BTC \
--model FEDformer \
--version Fourier \
--mode_select random \
--modes {best_params['modes']} \
--seq_len {best_params['seq_len']} \
--label_len {best_params['label_len']} \
--pred_len {best_params['pred_len']} \
--batch_size {best_params['batch_size']} \
--train_epochs {100} \
--d_model {best_params['d_model']} \
--learning_rate {best_params['learning_rate']} \
--dropout {best_params['dropout']} \
--use_gpu True \
--data custom \
--root_path /content/ \
--data_path BTC-USD.csv \
--features M \
--target Close \
--freq d \
--do_predict

"""

print("\nüöÄ Running training command:")
print(cmd)

result = subprocess.run(cmd, shell=True, text=True, capture_output=True)

print("\nüìå OUTPUT:")
print(result.stdout)

print("\n‚ö†Ô∏è ERRORS (if any):")
print(result.stderr)

import numpy as np
import matplotlib.pyplot as plt

true_ = np.load("/content/FEDformer/results/BTC_FEDformer_random_modes64_custom_ftM_sl96_ll48_pl48_dm512_nh8_el2_dl1_df2048_fc1_ebtimeF_dtTrue_exp_0/true.npy")
pred_ = np.load("/content/FEDformer/results/BTC_FEDformer_random_modes64_custom_ftM_sl96_ll48_pl48_dm512_nh8_el2_dl1_df2048_fc1_ebtimeF_dtTrue_exp_0/pred.npy")


plt.figure(figsize=(12,6))
plt.plot(true[0,:,0], label='–†–µ–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è', color='black')
plt.plot(pred[0,:,0], label='–ü—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è', color='blue')
plt.title("–ü—Ä–æ–≥–Ω–æ–∑ FEDformer: BTC-USD")
plt.xlabel("–ß–∞—Å–æ–≤—ñ –∫—Ä–æ–∫–∏")
plt.ylabel("–¶—ñ–Ω–∞")
plt.legend()
plt.show()

from FEDformer.utils.metrics import metric

mae, mse, rmse, mape, mspe = metric(pred, true)
print("MAE:", mae)
print("MSE:", mse)
print("RMSE:", rmse)
print("MAPE:", mape)

!zip -r fedformer_model.zip FEDformer